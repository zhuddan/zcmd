import { Injectable } from '@nestjs/common'
import { InjectRepository } from '@nestjs/typeorm'
import { FindOneOptions, Like, MoreThan, Repository } from 'typeorm'
import { CursorPageResponseDto } from '@/libs/common/src/dto/cursor-page-response.dto'
import { CursorPageDto } from '@/libs/common/src/dto/cursor-page.dto.ts'
import { PageResponseDto } from '@/libs/common/src/dto/page-response.dto'
import { buildTree } from '@/libs/common/src/utils/buildTree'
import { Create<%= upperCamelCase %>Dto } from './dto/create-<%= moduleName %>.dto'
import { <%= upperCamelCase %>PageDto } from './dto/<%= moduleName %>-page.dto'
import { Update<%= upperCamelCase %>Dto } from './dto/update-<%= moduleName %>.dto'
import { <%= upperCamelCase %>Entity } from './entities/<%= moduleName %>.entity'

@Injectable()
export class <%= upperCamelCase %>Service {
  constructor(
    @InjectRepository(<%= upperCamelCase %>Entity)
    private readonly <%= lowerCamelCase %>Repo: Repository<<%= upperCamelCase %>Entity>,
  ) {}

  /**
   * 创建<%= moduleNameCN %>
   */
  create(create<%= upperCamelCase %>Dto: Create<%= upperCamelCase %>Dto) {
    const <%= lowerCamelCase %> = this.<%= lowerCamelCase %>Repo.create(create<%= upperCamelCase %>Dto)
    return this.<%= lowerCamelCase %>Repo.save(<%= lowerCamelCase %>)
  }

  /**
   * 所有<%= moduleNameCN %>列表
   */
  async findAll() {
    return await this.<%= lowerCamelCase %>Repo.find()
  }

  /**
   * 分页查询<%= moduleNameCN %>
   */
  async paginate(dto: <%= upperCamelCase %>PageDto) {
    const { page = 1, pageSize = 5, sortBy = 'id', order = 'ASC', name } = dto
    const where: FindOneOptions<<%= upperCamelCase %>Entity>['where'] = {}
    if (name) {
      where.name = Like(`%${name}%`) // 模糊搜索
    }
    const [list, total] = await this.<%= lowerCamelCase %>Repo.findAndCount({
      where,
      skip: (page - 1) * pageSize,
      take: pageSize,
      order: sortBy ? { [sortBy]: order.toUpperCase() as 'ASC' | 'DESC' } : undefined,
    })
    return new PageResponseDto(list, total, page, pageSize)
  }

  /**
   * 树形结构<%= moduleNameCN %>
   */
  async findTree() {
    const all = await this.<%= lowerCamelCase %>Repo.find({ order: { sort: 'ASC' } })
    return buildTree(all)
  }

  /**
   * 游标分页查询<%= moduleNameCN %>
   */
  async cursorPaginate(dto: CursorPageDto) {
    const { lastId, limit = 10 } = dto
    const where = lastId ? { id: MoreThan(lastId) } : {}
    const list = await this.<%= lowerCamelCase %>Repo.find({
      where,
      take: limit,
      order: { id: 'ASC' },
    })
    return new CursorPageResponseDto(list)
  }

  /**
   * 根据<%= moduleNameCN %>ID查询<%= moduleNameCN %>
   */
  async findOne(id: number) {
    return await this.<%= lowerCamelCase %>Repo.findOneBy({ id })
  }

  /**
   * 更新<%= moduleNameCN %>信息
   */
  update(id: number, update<%= upperCamelCase %>Dto: Update<%= upperCamelCase %>Dto) {
    return this.<%= lowerCamelCase %>Repo.update(id.toString(), update<%= upperCamelCase %>Dto)
  }

  /**
   * 删除<%= moduleNameCN %>
   */
  async remove(id: number) {
    await this.<%= lowerCamelCase %>Repo.delete(id)
  }
}
